import json
from datetime import datetime
from pathlib import Path

LOG_FILE = Path("data/ingestion_log.json")


def log_ingestion(source: str, count: int, payload):
    LOG_FILE.parent.mkdir(parents=True, exist_ok=True)

    if LOG_FILE.exists():
        try:
            logs = json.loads(LOG_FILE.read_text())
        except Exception:
            logs = []
    else:
        logs = []

    logs.append({
        "source": source,
        "ingested": count,
        "timestamp": datetime.utcnow().isoformat()
    })

    LOG_FILE.write_text(json.dumps(logs, indent=2))


def read_logs():
    if not LOG_FILE.exists():
        return []

    try:
        return json.loads(LOG_FILE.read_text())
    except Exception:
        return []